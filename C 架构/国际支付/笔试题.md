笔试题分类：

1、字符串

2、多线程

3、事务

4、并发&幂等

5、数据一致性（如缓存和DB一致性）

6、死锁

7、数据结构

8、算法

9、Linux命令

10、SQL

11、文件处理





切换数据源

```java
@Aspect
@Component
@Lazy(false)
@Order(0) //Order设定AOP执行顺序 使之在数据库事务上先执行
public class SwitchDataSourceAop {

    @Before("execution(* com.fly.cash.admin.service.*.*(..))")
    public void process(JoinPoint joinPoint) {
        //此时为防止极端情况下出错,先进行清除
//        DataSourceContextHolder.clearDbType();
        String methodName = joinPoint.getSignature().getName();
        if (methodName.startsWith("get")
                || methodName.startsWith("count")
                || methodName.startsWith("find")
                || methodName.startsWith("list")
                || methodName.startsWith("select")
                || methodName.startsWith("query")) {
            DataSourceContextHolder.slave();
        } else {
            //切换dataSource
            DataSourceContextHolder.master();
        }
    }

}
```

启动加载数据

```java
@Service("commandBoardTodayFactory")
public class CommandBoardTodayFactory implements ApplicationContextAware, InitializingBean {

  private Map<String, CommandBoardTodayHandler> handlerMap;

  private ApplicationContext applicationContext;

  @Override
  public void afterPropertiesSet() throws Exception {

    final Map<String, CommandBoardTodayHandler> handlerMap =
        this.applicationContext.getBeansOfType(CommandBoardTodayHandler.class);
    this.handlerMap = handlerMap;

  }

  @Override
  public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {
    this.applicationContext = applicationContext;
  }

  public CommandBoardTodayHandler getBoardTodayHandler(String cate) {
    return this.handlerMap.get(cate + "BoardTodayHandler");
  }
} 
```

微服务调用+熔断

```java
@FeignClient(value = "COMMON-PAY-SERVICE", fallback = AccountRemoteServiceHystrix.class)
public interface AccountRemoteService extends AccountRemoteApi {

}
```

mybatis

```java
public interface CertContactsInfoMapper extends MyMapper<CertContactsInfo> {

    @Select(" SELECT COUNT(DISTINCT phone) FROM cert_contacts_info where id_user = #{idUser} ")
    int countDistinctPhone(@Param("idUser") Long idUser);

    @ResultMap("BaseResultMap")
    @Select(" SELECT  *  FROM (SELECT * FROM cert_contacts_info WHERE id_user = #{idUser}  ORDER BY create_time DESC ) AS c  GROUP BY phone limit #{offset},#{limit} ")
    List<CertContactsInfo> listDistinctPhoneByPrimaryKey(@Param("idUser") Long idUser,@Param("offset") Integer offset,@Param("limit")Integer limit);

}
```

对应xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fly.cash.collectionsync.dao.dwMapper.CertContactsInfoMapper">
  <resultMap id="BaseResultMap" type="com.fly.cash.collectionsync.dwModel.CertContactsInfo">
    <!--
      WARNING - @mbg.generated
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="id_user" jdbcType="BIGINT" property="idUser" />
    <result column="fr_name" jdbcType="VARCHAR" property="frName" />
    <result column="lt_name" jdbcType="VARCHAR" property="ltName" />
    <result column="company" jdbcType="VARCHAR" property="company" />
    <result column="phone" jdbcType="VARCHAR" property="phone" />
    <result column="title" jdbcType="VARCHAR" property="title" />
    <result column="en_name" jdbcType="VARCHAR" property="enName" />
    <result column="other_info" jdbcType="VARCHAR" property="otherInfo" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="update_time" jdbcType="TIMESTAMP" property="updateTime" />
    <result column="unique_id" jdbcType="VARCHAR" property="uniqueId" />
    <result column="app_code" jdbcType="VARCHAR" property="appCode" />
    <result column="province" jdbcType="VARCHAR" property="province" />
    <result column="city" jdbcType="VARCHAR" property="city" />
    <result column="memo" jdbcType="VARCHAR" property="memo" />
  </resultMap>
  
  <select id="listDistinctPhoneByPrimaryKey" resultType="com.fly.cash.collectionsync.dwModel.CertContactsInfo" parameterType="long">
    SELECT  fr_name frName,lt_name ltName,phone  FROM cert_contacts_info WHERE id_user = #{idUser} GROUP BY phone
  </select>
</mapper>
```

数据源相关配置的包位置

```
package com.fly.cash.admin.druid 
```



ip拦截

```java
@Component
public class IpVerifyInterceptor extends CommonHandlerInterceptor {

    private static final Logger logger = LoggerFactory.getLogger("sys-ip-log");

    private static final List<String> FILTER_URL_LIST = new ArrayList<>(1);

    static {
        FILTER_URL_LIST.add("/api/constant/queryStatusConstant");
    }

    private static final String USER_ATTRIBUTE = "Attr_U_W_A";

    @Autowired
    private SysIpWhiteListService sysIpWhiteListService;

    @Override
    public boolean preHandle(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o) throws Exception {
        String url = httpServletRequest.getRequestURI();
        if(FILTER_URL_LIST.contains(url)){
            return true;
        }
        //经过用户拦截器后
        Object object = httpServletRequest.getAttribute(USER_ATTRIBUTE);
        if(object != null){
            //是用户白名单的话 跳过ip校验
            if(sysIpWhiteListService.userWitheList(((WebUser)object).getUserId())){
                return true;
            }
        }
        String ip = getIpAddress(httpServletRequest);
        logger.warn(" ip verif  : {} ",ip);
        //无用户或者 非白名单用户进行 ip校验
        if(sysIpWhiteListService.requestIpWitheList(ip)){
            return true;
        }
        throw new IpVerifyException(IpVerifyErrorCode.IP_RESTRICTED_ERROR);
    }

    private String getIpAddress(HttpServletRequest request) {
        try {
            String ipAddress = request.getHeader("x-forwarded-for");
            if(ipAddress == null || ipAddress.length() == 0 || "unknown".equalsIgnoreCase(ipAddress)) {
                ipAddress = request.getHeader("Proxy-Client-IP");
            }
            if(ipAddress == null || ipAddress.length() == 0 || "unknown".equalsIgnoreCase(ipAddress)) {
                ipAddress = request.getHeader("WL-Proxy-Client-IP");
            }
            if(ipAddress == null || ipAddress.length() == 0 || "unknown".equalsIgnoreCase(ipAddress)) {
                ipAddress = request.getRemoteAddr();
                if(ipAddress.equals("127.0.0.1") || ipAddress.equals("0:0:0:0:0:0:0:1")){
                    //根据网卡取本机配置的IP
                    InetAddress inet=null;
                    try {
                        inet = InetAddress.getLocalHost();
                    } catch (UnknownHostException e) {

                    }
                    ipAddress= inet.getHostAddress();
                }
            }
            //对于通过多个代理的情况，第一个IP为客户端真实IP,多个IP按照','分割
            if(ipAddress!=null && ipAddress.length()>15){ //"***.***.***.***".length() = 15
                if(ipAddress.indexOf(",")>0){
                    ipAddress = ipAddress.substring(0,ipAddress.indexOf(","));
                }
            }
            return ipAddress;
        } catch (Exception e) {
            logger.error("get romote ip error,error message:" + e.getMessage());
            return "";
        }
    }


    @Override
    public int getOrder() {
        return 20;
    }
}

```





swagger





![image-20201220011320320](https://yeyangshu-picgo.oss-cn-shanghai.aliyuncs.com/img/image-20201220011320320.png)





线程池配置

```java
@Configuration
public class BusinessThreadPoolConfig extends AsyncConfigurerSupport {

    @Override
    @Bean(name = "businessAsync")
    public Executor getAsyncExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(50);
        executor.setMaxPoolSize(100);
        executor.setQueueCapacity(200);
        executor.setKeepAliveSeconds(60);
        executor.setThreadNamePrefix("business-async");
        //当任务数量超过MaxPoolSize和QueueCapacity时使用的策略，该策略是由调用任务的线程执行
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        executor.initialize();
        return executor;
    }

}



@Async("businessAsync")
    public void asyncPushBaseInfo(ChannelSyncOrder channelSyncOrder, UserBaseInfoParam userBaseInfoParam) {
        try {
            String filePath = ChannelSyncConstans.OSS_PATH_PREFIX_XIANJIN_CARD_BAIS_INFO + channelSyncOrder.getIdUser() + "_cert.json";
            this.saveToFs(filePath, JsonUtils.toJson(userBaseInfoParam));
            String storeUrl = OSSEnum.aliyun.name() + "://" + filePath;
            ChannelSyncOrder updateSyncOrder = new ChannelSyncOrder();
            updateSyncOrder.setId(channelSyncOrder.getId());
            updateSyncOrder.setExt4(storeUrl);
            updateSyncOrder.setUpdateTime(TimeUtils.currentTime());
            this.channelSyncOrderMapper.updateByPrimaryKeySelective(updateSyncOrder);
        } catch (Exception e) {
            logger.error(" asyncPushBaseInfo error : {} , {} ", channelSyncOrder.getIdUser(), e.getMessage());
            logger.error(e.getMessage(), e);
        }
    }
```



定时任务

```java
@Scheduled(cron = "0 0/1 * * * ?")
  public void executeCert() {
    logger.warn("executeCert start......");

    toAuth();

    logger.warn("executeCert end......");
  }
```

