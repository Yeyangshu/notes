# DB高可用能力

## 1 数据库数据级别

### 1.1 流水型数据

流水型数据容灾时特点： 每条数据间独立，新数据不依赖于老数据，可以随时切换新数据的存储位置，每条数据的主键自包含存储位置信息。单条数据的更新需要保证强一致性。流水型数据很方便做水平扩展。

IPAY代表： iacquirecenter、ipayment、ipaycore  收单／支付核心等

### 1.2 状态型数据

容灾时特点：每一次写操作必须基于前一个正确的状态。这是最棘手的一种数据，难以完美兼顾 RTO 和 RPO 。

IPAY代表：icif、iacctrans、icardcenter 会员／账务等

### 1.3 配置型数据

配置型DB特征：读比写访问量大，强依赖读，弱依赖写，不要求严格的读一致性。可以采用读写分离、一写多读的方式保证读操作的性能和高可靠。

IPAY代表：iconfig ，shareipayment   卡bin配置、渠道配置、资产配置、产品配置等

## 2 自带的DB主备容灾方案

![image-20201216214944556](https://yeyangshu-picgo.oss-cn-shanghai.aliyuncs.com/img/image-20201216214944556.png)

正常情况下，应用读写都在主库，通过Binlog形式，主库将数据同步到备库 

主库与备库数据主库与备库同步存在ms级别的延迟

在主库异常时候，通过切换数据源DNS，将数据切换到备库，将读写都切换到备库

![image-20201216215002538](https://yeyangshu-picgo.oss-cn-shanghai.aliyuncs.com/img/image-20201216215002538.png)

tips： 

1、为了考虑性能，MySQL 的复制都是异步复制，（半）同步复制意味着对数据库的强依赖又增加了一个节点。

2、在非同步复制的情况下，若主库出现故障，强制主备切将会导致未同步到备库的数据丢失。

3、中小企业综合容灾与成本的考量，一般会考虑此类单主单备方案。面试时可询问数据丢失的解决方案

4、在一些两地三中心方案中，跨地同步数据也使用主备同步方案。



附1： 主备异步、半同步与全同步复制

国际的主备切换使用了异步复制，比异步在高一层的为半同步复制，容灾等级再高一层的为全同步复制，可以将全同步复制理解为 RAID 1的复制方式。

### 2.1 异步复制

异步复制是MySQL默认自带的复制方式，主库和备库成功建立起复制关系后，在备库上会有一个IO线程去主库拉取binlog，并将binlog写到本地（Relaylog），然后备库会开启另外一个SQL线程去读取回放Relay log，通过这种方式达到Master-Slave数据同步的目的。

网上找图

### 2.2 半同步复制

介于异步复制和全同步复制之间，主库在执行完客户端提交的事务后不是立刻返回给客户端，而是等待至少一个从库接收到并写到relay log中才返回给客户端。相对于异步复制，半同步复制提高了数据的安全性，同时它也造成了一定程度的延迟，这个延迟最少是一个TCP/IP往返的时间。所以，半同步复制最好在低延时的网络中使用。

### 2.3 同步复制

同步复制就是一个事务在Master和Slave都执行后，才返回给用户执行成功



附2： 备库在一些读多写少的场景，且对数据实时一致性没有那么敏感的场景中，往往会使用到备库作为读库使用。IPAY目前实际上没有这么使用的，但应急上可以这么使用，在读库出现故障时，可直接将读库链接指向备库。





附3 : 蚂蚁主备切换不丢数据，切换流程 : 

1. 前置检查，检查主备数据库配置环境是否一致，检查不一致即退出；
2. 原主库设置read-only，停写；
3. 检查备库数据同步是否追上，即主备数据保证一致；
4. 将主库域名切换到备库；
5. 备库设置read-write, 打开写；
6. 主库进行kill session操作，触发应用client端重新创建链接，连到新库；
7. 为避免dns缓存，原主库kill session会多重复3次；

## 3 流水型数据高可用方案：

![image-20201216215033474](https://yeyangshu-picgo.oss-cn-shanghai.aliyuncs.com/img/image-20201216215033474.png)

特征： 搭建与主库不同数据源的FO库，在主库出现异常时，通过切换写入数据源，保证新流水落库时，不受影响。

tips : 

1. 主库真实故障时，历史单号无法获取到，对一些逆向请求的操作若订单在主库上，需要读取读库数据进行操作时，则将失败（如退款）

2. 主库故障时，若对落库请求的幂等有要求，则需接入全局幂等进行判断

3. 未接入全局幂等的应用一部分依赖于tair（始终有损），一些特别的应用，如itrade，使用zdal的throughall方式来保证幂等。

流水型的DB是占比最多的

## 4 状态型数据高可用方案

特征： 状态型方案，这里我把它分为两个场景：

1. 对数据需要保持强一致的，如账务数据
2. 能够容忍少量数据非强一致的，如会员 

#### 4.1 账务的FO方案

通过黑名单、快照库的配合，实现对数据的强一致

#### 4.2 其他的状态型容灾方案

IPAY的FO方案主要介绍会员的FO方案，其他变种大同小异 ，包括iar、icomsrc 都是类似的读库方案，但对切换瞬间产生的不一致性都没有强处理。

会员域的数据是典型的状态型数据，而且所有的数据都是关联在用户下面的，要在FO期间提供更新服务，必须保证某个用户的完整数据都在FO库，而FO库平时都是空的，因此在FO期间需要将用户迁移到FO库。而从哪个库迁移则要看写库的状态，如果写库可读（如FO演练场景）则从写库迁移，如果写库不可读，则从读库迁移；

**常规**

![image-20201216215113658](https://yeyangshu-picgo.oss-cn-shanghai.aliyuncs.com/img/image-20201216215113658.png)



**FO阶段**![image-20201216215134938](https://yeyangshu-picgo.oss-cn-shanghai.aliyuncs.com/img/image-20201216215134938.png)

写库恢复

![image-20201216215252857](https://yeyangshu-picgo.oss-cn-shanghai.aliyuncs.com/img/image-20201216215252857.png)

![image-20201216215338405](https://yeyangshu-picgo.oss-cn-shanghai.aliyuncs.com/img/image-20201216215338405.png)



会员FO的大体方案如下：

1. 切换FO后（FO状态），如果要更新某个用户，需要将用户从读库或者写库迁移到FO库；
2. 在FO恢复阶段（兼容状态），如果要更新某个用户，需要将用户从FO库迁移到写库；同时定时任务在后台迁移用户到写库；
3. 等FO库的用户全部迁移到写库后，则恢复到常规状态。



如何迁移用户

有两个迁移方向：

1. FO期间，从写库或读库迁移到FO库；

1. 兼容期间，从FO库迁移到写库；

迁移用户的目的是保证当前写库有需要更新的用户的完整数据，因此迁移用户是更新用户的前置条件，放在业务处理前面，作为前置事项；

一个更新请求过来，需要知道要更新的用户该不该被迁移，判断逻辑如下：

1. FO期间，如果用户不在FO库，则迁移到FO库；

1. 兼容期间，如果用户在FO库，则迁移到写库；

1. 其他情况不需要迁移。

迁移用户在不同状态下的流程不同：

1. FO期间，将用户从写库或读库查询出来，然后保存到FO库；

1. 兼容期间，将用户从FO库查询出来，然后删除写库数据，将FO库数据保存到写库，最后删除FO库数据。

## 5 配置型数据高可用方案

配置型数据高可用方案较其他而言简单的多，一般采用读写分离的方式来实现高可用，一主多读