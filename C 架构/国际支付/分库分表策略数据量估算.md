# 分表策略

ifinflux_id，流水号，标准 31位：8位日期+1位业务版本号+1位区域位+3位系统标识码+3位业务标识码+1位主库备库+2位月份码+2位用户分割位+2位预留位+8位序列码

| Date（日期YYYYMMDD） | data version 数据版本位(0,1=normal,8=new recon) | RegionCode区域位(0=美国,1=新加坡) | ifinflux(system code)系统识别码 | 业务标识码：标识原子单还是组合单atom=1，composite=0 | Biz code业务标识码 | 业务扩展码：标识主库和FO库(0=主库,1=FO库) | 业务扩展码：Month Partition月份位（从00-11，99特指为退款） | user partition用户分割位第一位 标识 库位两位标识 第一个分表标识如：05=flux_00_0库atom_05_01表 | 分库分表预留位（现在暂时没用） | SeqNo序列号 |
| :------------------: | :---------------------------------------------: | :-------------------------------: | :-----------------------------: | :-------------------------------------------------: | :----------------: | :---------------------------------------: | :--------------------------------------------------------: | :----------------------------------------------------------: | :----------------------------: | ----------- |
|       20160606       |                        1                        |                 1                 |               031               |                          1                          |         03         |                     0                     |                             99                             |                              05                              |               24               | 00029904    |

幂等性：

- 根据8位序列码递增实现唯一性。

- 根据日期重新递增，实现序列码范围内重复 序列码+日期唯一；

- 根据区域位，实现不同机房的数据库 序列码+区域位唯一；

- 根据用户分割位，序列表根据用户分割位分库分表，每张表单独递增，实现 序列码+用户码唯一；

- 根据主库、FO库区分，实现不同数据库 序列码+数据库标识码唯一；

## 1.1 现有的分表策略

- 根据用户位2位，分库可以最多100个库；每个库中最多可以分100个表，实际情况因为库容量限制一般分成10个表
- 日期分表位2位，根据日期月份分表，最多可以分12个表

因此在一个库中，一个逻辑表可以有12*10个分表。

ipaycore采用10个库，因此总量是1,200个分表。扩充到100个库后，可以达到12,000个分表。

## 1.2 分表策略新思路

目前国际的数据量并不大，退款周期或者退票可以超过一年，甚至有的可以达到两年，所以如果在线数据要保留1年，并且如果按照月份来分表，两年的数据会进入同一张表。将来数据清理只能以行级清理。

如果按照**年份**进行分表，可以避免后续的行级清理。年份为可以是1位，最多可以有10份，数据10年轮一回。有足够的时间清理历史数据。因此形成如下的方案：

该策略下首先保证了分表的数量不小于现有的分表数量；另外数据清理可以按照年份和月份进行，比如每月一清，每次清理16个月前的数据，做到**表级清理**。

## 1.3 数据的分库分表策略

根据分库分表策略由以下两个因素：

- 是否可以按照月份进行分表

- 是否可以进入的FO（fail over故障转移）库

充值单据完全可以按月分表，也可以进入FO库。充值单据作为业务的起点，需要能够找到与之关联的撤销、请款和退款。因为单据的生命周期的关系，撤销单据和请款单据跟着充值单据同库同表；而充退单据只能同库但不按月份分表。充值单据进入FO库后，该充值单据上随后发生的请款，撤销以及充退都进入FO。但是请款、撤销和充退本身不作自主FO。提现单据不按月分表，也不进行自主FO。

- **原子交换**的分库分表和它的父节点（**组合交换**）保持一致。FO位、用户位、月份位相同。

- 相关联的**请款组合单**保持和**充值组合单**相同的FO位、用户位、月份位。

- 相关联的**撤销组合单**保持和**充值组合单**相同的FO位、用户位、月份位。

- 相关联的**充退组合单**保持和**充值组合单**相同的FO位、用户位相同，但不按月份分表

- 相关联的**充值清算原子单**保持和**充值组合单**相同的FO位**、**用户位、月份位。

- 相关联的**充退/充退退票清算原子单**保持和**充退组合**单相同的FO位、用户位，不按月份分表

- 相关联的**拒付/拒付反转清算原子单**保持和**充值组合**单相同的FO位、用户位，但不按月份分表

- 提现组合交换以及提现相关的原子交换，使用用户位进行分库分表，但不按月份分表。

# 数据量估算

以线上数据库支撑一年交易为容量要求。

## 1 充值数据量估算

每日**50,000,000**笔充值单据创建

一年生成单据50,000,000 * 365 = 18,250,000,000组合充值单据

一个单据平均生成4个原子单据，总共创建记录：18,250,000,000 * 4 = 73,000,000,000

每个分表的容量20G，每条记录2K，每个分表最多可以容纳10,000,000条记录。那么一年产生的：

组合单据需要分表: 18,250,000,000/10,000,000 = 1825个分表

原子记录需要分表：73,000,000,000/ 10,000,000 = 7300个分表;

分库分表按照：10库，10表，12月份可以得到1200个分表。缺口6倍。扩到100个库时，12,000完全可以支撑一年充值吞吐量。

物理存储按照一个库1.6T计算，10库可以支持16T。但是1200个分表需要1200 * 20G = 24,000G = 24T，缺口8T。扩到100个库时，可以支持240T，完全可以支持一年的吞吐量

## 2 充退数据量估算

充退按照1/10充值的量进行估算

组合单据需要分表: 18,250,000,000/10,000,000 = 182.5个分表

原子记录需要分表(平均需要3个原子单据完成一次充退)： 547.5个分表;

分库分表按照：10库，10表，无月份，可以得到100个分表。缺口6倍。扩到100个库时，1,000个分表完全可以支撑一年充值吞吐量。



月+组合单标识

'iff_composite_settlement_' + substring(#composite_id#,19,21)+'_'+ (substring(#composite_id#,13,14) == '0' ? substring(#composite_id#,17,19) : '00')