# 分区表

MySQL官网：https://dev.mysql.com/doc/refman/8.0/en/partitioning.html

## 1 分区表的应用场景

1. 表非常大以至于无法全部放在内存中，或者只在表中的最后部分有热点数据，其他均是历史数据
2. 分区表的数据更容易维护
   - 批量删除大量数据可以使用清除整个分区的方式
   - 对一个独立分区进行优化、检查、修复等操作
3. 分区表的数据可以分布在不同的物理设备上，从而高效地利用多个硬件设备
4. 可以使用分区表来避免某些特殊的瓶颈
   - innodb的单个索引互斥访问
   - ext3文件系统的iNode锁竞争
5. 可以备份和恢复独立的分区

## 2 分区表的限制

1. 一个表最多只有1024个分区，在5。7版本的时候可以支持8196个分区
2. 在早期的MySQL中，分区表达式必须是整数或者是返回整数的表达式，在MySQL5.5中，某些场景可以直接使用列来进行分区
3. 如果分区字段中有主键或者唯一索引的列，那么所有主键列和唯一索引列都必须包含进来
4. 分区表无法使用外键约束

## 3 分区表的原理

分区表由多个相关的底层实现，这个底层表也是由句柄对象标识，我们可以直接访问各个分区，存储引擎管理分区的各个底层表和管理普通表一样（所有底层表都必须使用相同的存储引擎），分区表的索引只是在各个底层表上各自加上一个完全相同的索引。从存储引擎的角度来看，底层表和普通表没有任何不同，存储引擎也无须知道这是一个普通表还是一个分区表的一部分。

分区表的操作按照以下的操作逻辑进行：

1. select查询

   当查询一个分区表的时候，分区层先打开并锁住所有的底层表，优化器先判断是否可以过滤部分分区，然后再调用对应的存储引擎接口访问各个分区的数据

2. insert操作

   当写入一条记录的时候，分区层先打开并锁住所有的底层表，然后确定哪个分区接受这条记录，再将记录写入对应底层表

3. delete操作

   当删除一条记录时，分区层先打开并锁住所有的底层表，然后确定数据对应的分区，最后对相应底层表进行删除操作

4. update操作

   当更新一条记录时，分区层先打开并锁住所有的底层表，mysql先确定需要更新的记录再哪个分区，然后取出数据并更新，再判断更新后的数据应该再哪个分区，最后对底层表进行写入操作，并对源数据所在的底层表进行删除操作

有些操作时支持过滤的，例如，当删除一条记录时，MySQL需要先找到这条记录，如果where条件恰好和分区表达式匹配，就可以将所有不包含这条记录的分区都过滤掉，这对update同样有效。如果是insert操作，则本身就是只命中一个分区，其他分区都会被过滤掉。mysql先确定这条记录属于哪个分区，再将记录写入对应的分区表，无须对任何其他分区进行操作

虽然每个操作都会“先打开并锁住所有的底层表”，但这并不是说分区表在处理过程中是锁住全表的，如果存储引擎能够自己实现行级锁，例如innodb，则会在分区层释放对应表锁。

## 4 分区表的类型

官网：https://dev.mysql.com/doc/refman/8.0/en/partitioning-types.html

### 4.1  范围分区

### 4.2 列表分区

### 4.3 列分区

###  4.4 hash分区

### 4.5 key分区

### 4.6 子分区



## 5 如何使用分区表

## 6 使用分区表的时候需要注意的问题

