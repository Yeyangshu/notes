# 大型网站及其架构演进过程

## 1 什么是大型网站

- 访问量：高并发的访问量
- 数据量：海量数据

除了海量数据和高并发的访问量，本身业务和系统的复杂度也是考察方面。

大型网站要支持海量的数据和非常高的访问量，那么它肯定是一个分布式系统。

## 2 大型网站架构演进

### 2.1 单机交易网站

- 用户
- 商品
- 交易

### 2.2 单机负载告警，数据库与应用分离

数据库与应用从一台机器分到两台。

### 2.3 应用服务器负载告警，如何让应用服务器走向集群

应用服务器从一台变为两台。这两个应用服务器之间没有直接的交互，他们都是依赖数据库对外提供服务的。有下面两个问题需要解决：

- 最终用户对两个应用服务器访问的选择问题。
  - DNS
  - 负载均衡服务器
- Session 的问题。

#### 2.3.1 引入负载均衡设备

#### 2.3.2 集群 Session 问题

解决方案

1. Session Sticky：负载均衡服务器能够根据每次请求的会话标识来进行请求转发，称为
2. Session Replication：不再要求负载均衡服务器来保证同一个会话的多次请求必须到同一个 Web 服务器上。Web 服务器之间则增加了会话同步。通过同步就保证了不同 Web 服务器之间的 Session 数据的一致。
3. Session 数据集中存储：把 Session 数据集中存储起来，然后不同的 Web 服务器从同样的地方来获取 Session。
4. Cookie  Based：通过 Cookie  来传递 Session。

对于大型网站来说，Session Sticky 和 Session 数据集中存储是比较好的方案，而这两个方案又各有优劣，需要在具体的场景中做出选择和权衡。

### 2.4 数据读压力变大，读写分离

#### 2.4.1 采用数据库作为读库

对于大型网站，有不少业务是读多写少的，可以考虑使用读写分离。

问题：

- 数据复制的问题
- 应用对于数据源选择的问题

#### 2.4.2 搜索引擎其实是一个读库

#### 2.4.3 缓存

##### 2.4.3.1 数据缓存

存储热数据而不是全部数据，需要清除过期数据。

这种方式有一个要求，即根据数据库记录的变化取更新缓存的代码要能够理解业务逻辑。

##### 2.4.3.2 页面缓存

数据缓存可以加速应用在响应请求的数据读取速度，但是最终应用返回给用户的主要还是页面，有些动态的产生的页面或页面的一部分特别热，我们可以对这些内容进行缓存。ESI 就是这种情况的一个规范。

### 2.5 弥补关系型数据库的不足，引入分布式存储系统

常见的分布式存储系统有分布式文件系统、分布式 Key-Vlaue 系统和分布式数据库。

- 分布式文件系统：解决小文件和大文件的存储问题
- 分布式 Key-Vlaue 系统：提供高性能的半结构化的支持
- 分布式数据库：较好的解决大型网站中的大数据量和高并发访问的问题。

### 2.6 读写分离后，数据库又遇到瓶颈

#### 2.6.1 专库专用、数据垂直拆分

垂直拆分就是把数据库中的不同业务拆分到不同的数据库中。

考虑跨业务的分布式事务。

#### 2.6.2 垂直拆分后的单机遇到瓶颈，数据水平拆分

数据的水平拆分就是把同一个表的数据拆到两个数据库中。

### 2.7 数据库的问题解决后，应用面对的新的挑战

#### 2.7.1 拆分应用

根据服务系统拆分

- 商品系统
- 用户系统
- 交易系统

### 2.9 消息中间件





# 中间件

分类：

- 远程过程调用和对象访问中间件：主要解决分布式环境下应用的互相访问问题。
- 消息中间件：主要解决应用之间的消息传递、解耦、异步的问题。
- 数据访问中间件：主要解决应用访问数据库的共性问题的组件。



95页



## 1 服务框架

## 2 数据访问层

### 2.1 数据库从单机到分布式的挑战和应对

### 2.2 数据垂直/水平拆分的困难

### 2.3 单机变为多机后，事务如何处理

分布式事务模型与规范

一致性基础理论—CAP/BASE

Paxos协议

### 2.4 多机 Sequence 问题与处理

- 唯一性：UUID
- 连续性：分布式环境中生成 Id 的连续性

方案：把所有的 Id 集中放在一个地方进行管理，对每个 Id 序列独立管理，每台机器使用 Id 时都从这个 Id 生成器上取。

- 生成器性能问题
- 生成器稳定性问题
- 生成器 Id 存储的问题

### 2.5 应对多机的数据查询

#### 2.5.1 跨库 join 

解决思路：

- 在应用层把原来的数据库的 join 操作分成多次的数据操作
- 数据冗余
- 借助外部系统（例如搜索引擎）解决一些跨库的问题

#### 2.5.2 外键约束

#### 2.5.3 跨库查询问题及解决

## 3 消息中间件

JMS：Java EE 中的消息规范

消息的最终一致性方案



# 构建大型网站的其他要素

## 1 加速静态内容访问的 CDN

## 2 大型网站的存储支持

### 2.1 分布式文件存储系统

### 2.2 NoSQL

HBase

### 2.3 缓存系统

1. Redis：一致性哈希

   缓存和存储数据一致性

2. 页面缓存：页面中分为相对静态的内容和动态的内容，相对静态的内容可以进行缓存而不是每次都要重新渲染。

   ESI

### 2.4 搜索系统

### 2.5 发布系统

### 2.6 监控系统

### 2.7 依赖管理系统

### 2.8 多机房问题分析