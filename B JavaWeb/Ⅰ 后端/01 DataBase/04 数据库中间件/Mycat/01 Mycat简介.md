# Mycat 简介

Mycat 官方网站：http://www.mycat.org.cn/

Mycat 源码：https://github.com/MyCATApache/Mycat-Server

Mycat 下载地址：http://dl.mycat.org.cn/

## 1 数据库切分概述

### 1.1 OLTP 和 OLAP

海量数据的存储与访问成为系统设计与使用的瓶颈问题，对于海量数据处理，按照使用场景，主要分为两种类型： `联机事务处理（OLTP）` 和 `联机分析处理（OLAP）`。

- `联机事务处理（OLTP）` ：也称为面向交易的处理系统，其基本特征是原始数据可以立即传送到计算中心进行处理，并在很短的时间内给出处理结果。

- `联机分析处理（OLAP）` ：是指通过多维的方式对数据进行分析、查询和报表，可以同数据挖掘工具、统计分析工具配合使用，增强决策分析功能。

![image-20210130100124309](https://yeyangshu-picgo.oss-cn-shanghai.aliyuncs.com/img/image-20210130100124309.png)

### 1.2 关系型数据库和 NoSQL 数据库

针对上面两类系统有多种技术实现方案，存储部分的数据库主要分为两大类：`关系型数据库`与`NoSQL数据库`。

- `关系型数据库`：建立在关系模型基础上的数据库，其借助于集合代数等数学概念和方法来处理数据库中的数据。主流的oracle、DB2、MS SQL Server和mysql都属于这类传统数据库。

- `NoSQL数据库`：全称为Not Only SQL，意思就是适用关系型数据库的时候就使用关系型数据库，不适用的时候也没有必要非使用关系型数据库不可，可以考虑使用更加合适的数据存储。主要分为临时性键值存储（memcached、Redis）、永久性键值存储（ROMA、Redis）、面向文档的数据库（MongoDB、CouchDB）、面向列的数据库（Cassandra、HBase），每种NoSQL都有其特有的使用场景及优点。

![image-20210130100208514](https://yeyangshu-picgo.oss-cn-shanghai.aliyuncs.com/img/image-20210130100208514.png)

### 1.3 何为数据切分？

数据切分指通过某种特定的条件，将我们存放在同一个数据库中的数据分散存放到多个数据库（主机）上面，以达到分散单台设备负载的效果。

数据的切分（Sharding）根据其切分规则的类型，可以分为两种切分模式。一种是按照不同的`表`（或者`Schema`）来切分到不同的数据库（主机）之上，这种切可以称之为`数据的垂直（纵向）切分`；另外一种则是根据表中的数据的逻辑关系，将同一个表中的数据按照某种条件拆分到多台数据库（主机）上面，这种切分称之为数据的`水平（横向）切分`。

#### 1.3.1 垂直切分

一个数据库由很多表的构成，每个表对应着不同的业务，垂直切分是指按照业务将表进行分类，分布到不同的数据库上面，这样也就将数据或者说压力分担到不同的库上面，如下图：

![img](https://cdn.nlark.com/yuque/0/2021/png/658548/1610181911481-55e1e1be-0a69-4a69-a0ed-020df6ffe6d3.png)

垂直切分的优缺点：

优点：

- 拆分后业务清晰，拆分规则明确；

- 系统之间整合或扩展容易；

- 数据维护简单。

缺点：

- 部分业务表无法 join，只能通过接口方式解决，提高了系统复杂度；

- 受每种业务不同的限制存在单库性能瓶颈，不易数据扩展跟性能提高；

- 事务处理复杂。

#### 1.3.2 水平切分

相对于垂直拆分，水平拆分不是将表做分类，而是按照某个字段的某种规则来分散到多个库之中，每个表中包含一部分数据。简单来说，我们可以将数据的水平切分理解为是按照数据行的切分，就是将表中的某些行切分到一个数据库，而另外的某些行又切分到其他的数据库中，如图：

![img](https://cdn.nlark.com/yuque/0/2021/png/658548/1610181911968-1d3cc690-f7b6-429b-822e-043489410062.png)

拆分数据就需要定义分片规则。关系型数据库是行列的二维模型，拆分的第一原则是找到拆分维度。比如：从会员的角度来分析，商户订单交易类系统中查询会员某天某月某个订单，那么就需要按照会员结合日期来拆分，不同的数据按照会员 ID 做分组，这样所有的数据查询 join 都会在单库内解决；如果从商户的角度来讲，要查询某个商家某天所有的订单数，就需要按照商户 ID 做拆分；但是如果系统既想按会员拆分，又想按商家数据，则会有一定的困难。如何找到合适的分片规则需要综合考虑衡量。

##### 1.3.2.1 几种典型的分片规则

- 按照用户 ID 求模，将数据分散到不同的数据库，具有相同数据用户的数据都被分散到一个库中；

- 按照日期，将不同月甚至日的数据分散到不同的库中；

- 按照某个特定的字段求摸，或者根据特定范围段分散到不同的库中。

比如 id 取模：

![img](https://cdn.nlark.com/yuque/0/2021/png/658548/1610181912502-5aaf3b8e-b249-4927-b9db-ff432df08ce1.png)

既然数据做了拆分有优点也就优缺点。

优点：

- 拆分规则抽象好，join 操作基本可以数据库做；

- 不存在单库大数据，高并发的性能瓶颈；

- 应用端改造较少；

- 提高了系统的稳定性跟负载能力。

缺点：

- 拆分规则难以抽象；

- 分片事务一致性难以解决；

- 数据多次扩展难度跟维护量极大；

- 跨库 join 性能较差。

#### 1.3.3 垂直/水平切分共同问题

 垂直/水平切分共同的特点缺点有：

- 引入分布式事务的问题；

- 跨节点 Join 的问题；

- 跨节点合并排序分页问题；

- 多数据源管理问题。

针对数据源管理，目前主要有两种思路：

1. `客户端模式`，在每个应用程序模块中配置管理自己需要的一个（或者多个）数据源，直接访问各个数据库，在模块内完成数据的整合；

2. 通过`中间代理层`来统一管理所有的数据源，后端数据库集群对前端应用程序透明；

## 2 Mycat 前世今生

### 2.1 Mycat由来

### 2.2 Mycat概述

![image-20210130204954201](https://yeyangshu-picgo.oss-cn-shanghai.aliyuncs.com/img/image-20210130204954201.png)

### 2.3 Mycat原理

Mycat的原理中最重要的一个动词是“拦截”，它拦截了用户发送过来的SQL语句，首先对SQL语句做了一些特定的分析：如分片分析、路由分析、读写分离分析、缓存分析等，然后将此SQL发往后端的真实数据库，并将返回的结果做适当的处理，最终再返回给用户。

![img](https://cdn.nlark.com/yuque/0/2021/png/658548/1610181913832-22dd54a3-b96a-4837-8fcd-9327704185ca.png)

当 Mycat 收到一个 SQL 时，会先解析这个 SQL，查找涉及到的表，然后看此表的定义，如果有分片规则，则获取到 SQL 里分片字段的值，并匹配分片函数，得到该 SQL 对应的分片列表，然后将 SQL 发往这些分片去执行，最后收集和处理所有分片返回的结果数据，并输出到客户端。以 select * from Orders where prov = ? 语句为例，查到 prov=wuhan，按照分片函数，wuhan 返回 dn1，于是 SQL 就发给了 MySQL1，去取 DB1 上的查询结果，并返回给用户。

如果上述 SQL 改为 select * from Orders where prov in (‘wuhan’,‘beijing’)，那么，SQL 就会发给 MySQL1 与 MySQL2 去执行，然后结果集合并后输出给用户。

## 3 Mycat 中的概念

### 3.1 数据库中间件

Mycat 是数据库中间件，就是介于数据库与应用之间，进行数据处理与交互的中间服务。

![image-20210130210325290](https://yeyangshu-picgo.oss-cn-shanghai.aliyuncs.com/img/image-20210130210325290.png)

如上图所表示，数据被分到多个分片数据库后，应用如果需要读取数据，就要需要处理多个数据源的数据。如果没有数据库中间件，那么应用将直接面对分片集群，数据源切换、事务处理、数据聚合都需要应用直接处理，原本该是专注于业务的应用，将会花大量的工作来处理分片后的问题，最重要的是每个应用处理将是完全的重复造轮子。

所以有了数据库中间件，应用只需要集中与业务处理，大量的通用的数据聚合，事务，数据源切换都由中间件来处理，中间件的性能与处理能力将直接决定应用的读写性能，所以一款好的数据库中间件至关重要。

### 3.2 逻辑库(schema)

通常对实际应用来说，并不需要知道中间件的存在，业务开发人员只需要知道数据库的概念，所以数据库中间件可以被看做是一个或多个数据库集群构成的逻辑库。

![image-20210130210858055](https://yeyangshu-picgo.oss-cn-shanghai.aliyuncs.com/img/image-20210130210858055.png)

### 3.3 逻辑表（table）

#### 3.3.1 逻辑表

分布式数据库中，对应用来说，读写数据的表就是逻辑表。逻辑表，可以是数据切分后，分布在一个或多个分片库中，也可以不做数据切分，不分片，只有一个表构成。

#### 3.3.2 分片表

分片表，是指那些原有的很大数据的表，需要切分到多个数据库的表，这样，每个分片都有一部分数据，所有分片构成了完整的数据。

#### 3.3.3 非分片表

一个数据库中并不是所有的表都很大，某些表是可以不用进行切分的，非分片是相对分片表来说的，就是那些不需要进行数据切分的表。

#### 3.3.4 ER 表

关系型数据库是基于实体关系模型（Entity-Relationship Model）之上，通过其描述了真实世界中事物与关系，Mycat 中的 ER 表即是来源于此。根据这一思路，提出了基于 E-R 关系的数据分片策略，子表的记录与所关联的父表记录存放在同一个数据分片上，即子表依赖于父表，通过表分组（Table Group）保证数据 Join 不会跨库操作。

表分组（Table Group）是解决跨分片数据 join 的一种很好的思路，也是数据切分规划的重要一条规则。

#### 3.3.5 全局表

一个真实的业务系统中，往往存在大量的类似字典表的表，这些表基本上很少变动，字典表具有以下几个特
性：

- 变动不频繁；

- 数据量总体变化不大；
- 数据规模不大，很少有超过数十万条记录。

对于这类的表，在分片的情况下，当业务表因为规模而进行分片以后，业务表与这些附属的字典表之间的关联，就成了比较棘手的问题，所以 Mycat 中通过数据冗余来解决这类表的 join，即所有的分片都有一份数据的拷贝，所有将字典表或者符合字典表特性的一些表定义为全局表。

数据冗余是解决跨分片数据 join 的一种很好的思路，也是数据切分规划的另外一条重要规则。

### 3.4 分片节点(dataNode)

数据切分后，一个大表被分到不同的分片数据库上面，每个表分片所在的数据库就是分片节点（dataNode）。

### 3.5 节点主机(dataHost)

数据切分后，每个分片节点（dataNode）不一定都会独占一台机器，同一机器上面可以有多个分片数据库，这样一个或多个分片节点（dataNode）所在的机器就是节点主机（dataHost），为了规避单节点主机并发数限制，尽量将读写压力高的分片节点（dataNode）均衡的放在不同的节点主机（dataHost）。

### 3.6 分片规则(rule)

前面讲了数据切分，一个大表被分成若干个分片表，就需要一定的规则，这样按照某种业务规则把数据分到某个分片的规则就是分片规则，数据切分选择合适的分片规则非常重要，将极大的避免后续数据处理的难度。

### 3.7 全局序列号(sequence)

数据切分后，原有的关系数据库中的主键约束在分布式条件下将无法使用，因此需要引入外部机制保证数据
唯一性标识，这种保证全局性的数据唯一标识的机制就是全局序列号（sequence）。

### 3.8 多租户

多租户技术或称多重租赁技术，是一种软件架构技术，它是在探讨与实现如何于多用户的环境下共用相同的系统或程序组件，并且仍可确保各用户间数据的隔离性。在云计算时代，多租户技术在共用的数据中心以单一系统架构与服务提供多数客户端相同甚至可定制化的服务，并且仍然可以保障客户的数据隔离。目前各种各样的云计算服务就是这类技术范畴，例如阿里云数据库服务（RDS）、阿里云服务器等等。多租户在数据存储上存在三种主要的方案，分别是：

#### 3.8.1 独立数据库

这是第一种方案，即一个租户一个数据库，这种方案的用户数据隔离级别最高，安全性最好，但成本也高。

优点：

- 为不同的租户提供独立的数据库，有助于简化数据模型的扩展设计，满足不同租户的独特需求；如果出现故障，恢复数据比较简单。

缺点：

- 增大了数据库的安装数量，随之带来维护成本和购置成本的增加。这种方案与传统的一个客户、一套数据、一套部署类似，差别只在于软件统一部署在运营商那里。如果面对的是银行、医院等需要非常高数据隔离级别的租户，可以选择这种模式，提高租用的定价。如果定价较低，产品走低价路线，这种方案一般对运营商来说是无法承受的。

#### 3.8.2 共享数据库，隔离数据架构

这是第二种方案，即多个或所有租户共享 Database，但是每个租户一个 Schema。

优点：

- 为安全性要求较高的租户提供了一定程度的逻辑数据隔离，并不是完全隔离；每个数据库可以支持更多的租
  户数量。

缺点：

- 如果出现故障，数据恢复比较困难，因为恢复数据库将牵扯到其他租户的数据；
- 如果需要跨租户统计数据，存在一定困难。

#### 3.8.3 共享数据库，共享数据架构

这是第三种方案，即租户共享同一个 Database、同一个 Schema，但在表中通过 TenantID 区分租户的数据。这是共享程度最高、隔离级别最低的模式。

优点：

- 三种方案比较，第三种方案的维护和购置成本最低，允许每个数据库支持的租户数量最多。

缺点：

- 隔离级别最低，安全性最低，需要在设计开发时加大对安全的开发量；
- 数据备份和恢复最困难，需要逐表逐条备份和还原；
- 如果希望以最少的服务器为最多的租户提供服务，并且租户接受以牺牲隔离级别换取降低成本，这种方案最
  适合。

![image-20210130212633956](https://yeyangshu-picgo.oss-cn-shanghai.aliyuncs.com/img/image-20210130212633956.png)